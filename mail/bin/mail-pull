#!/bin/sh

# MAIL-PULL
# Simon Hugh Moore
#
# Pull and tag mail from server.

maildir=~/.mail

# Move a message file while removing its UID-part
# within the 'account' maildir.
_move() {
    s=${1##*/}
    s=${s%%,*}
    prefix=$( echo $1 | grep -o "$maildir/[^/]*" )
    mv -f $1 $prefix/$2/cur/$s
}

# move all files tagged 'deleted' to a 'deleted' dir.
for i in $(notmuch search --output=files tag:deleted AND NOT path:'/.*\/deleted\/.*/' ); do
    echo "$i"
    _move $i "deleted"
done

# Pull all mail
mbsync -c "$XDG_CONFIG_HOME"/mbsync/mbsyncrc -a

# Not much
notmuch new

# count the number of new messages
count=$( notmuch count tag:new )

# retag all new messages as inbox and unread
notmuch tag -new +inbox +unread -- tag:new

me="/.*@simonhugh.xyz|simonhugh@mailbox.org|simon.h.moore94@gmail.com/"

# tag all messages from "me" as sent and remove inbox,unread tags unless addressed to me.
notmuch tag -new +sent -- "from:$me"
notmuch tag -unread -inbox -- tag:sent AND NOT "to:$me"

# tag all messages with 'noreply' in address.
notmuch tag +noreply -- "from:/^.*noreply.*$/"

# notify of new messages
if [ $count = 1 ]; then
    notify-send -u normal "Mail" "You have 1 new message!" # singular
elif [ $count != 0]; then
    notify-send -u normal "Mail" "You have $count new messages!" #  plural
fi

