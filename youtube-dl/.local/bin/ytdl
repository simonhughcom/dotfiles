#!/bin/sh

# YTDL
# Simon Hugh Moore
#
# This script enables you to have separate configs for video and playlist
# downloading which is useful for having different youtube-dl templates.
# The script can also provide notifications.
# 
# Use:
# -v    : download video.
# -p    : download playlist.
# -n    : turn on notifications.

_dependency(){ command -v "$1" > /dev/null || { echo "error: "$1" not found"; exit 1; }; }
_dependency "youtube-dl"
_dependency "ts"

runtime_dir=$XDG_RUNTIME_DIR/ytdl
mkdir -p $runtime_dir

# Task Spooler
export TMPDIR=$runtime_dir/ts
mkdir -p $TMPDIR
ts -S 4

config_dir=$XDG_CONFIG_HOME/youtube-dl
video_config=$config_dir/config
hq_config=$config_dir/hq.config
playlist_config=$config_dir/pl.config
slow_config=$config_dir/slow.config
audio_config=$config_dir/audio.config
config=$video_config

__usage="
Usage: $(basename "$0") [OPTIONS]
Download video or playlist, with or without notifications
Any argument starting with 'http' will be accepted as URL

Options:
  -n, --notify                               Turn on notifications
  -v, --video                                Download single video
  -q, --hq                                   Download single high quality video
  -a, --audio                                Download audio only
  -p, --playlist                             Download playlist
  -s, --slow                                 Don't use aria2
  -u, --url=url                              URL to download
  -h, --help                                 Print this help message
"

_get_title(){
    # if failed, return url
    youtube-dl --get-title "$1" 2>/dev/null || echo "$1"
}

_download(){ 
    title="$( _get_title "$url" )"
    notify-send 'Added Download to queu...' ''"$title"''

    # Use printf to allow the use of ' to protect against command injection
    cmd="$( printf "youtube-dl --config-location '%s' --exec \"ffmpeg -i {} -c:v copy -c:a copy -metadata URL='%s' {}.tmp.mkv;mv -f {}.tmp.mkv {}\" '%s' || ( notify-send 'Failed to download!' '%s' && exit 1)" "$config" "$url" "$url" "$( echo "$title" | sed "s/'/'\"'\"'/g" )" )"
    ts -L ytdl sh -c "$cmd"

    ts -d -L ytdl notify-send 'Finished Download!' ''"$title"''
    exit
}


while test $# -gt 0; do
    case "$1" in
        -h|--help) echo "$__usage"; exit ;;
        -t|--ts) shift; ts $@; exit;;
        -n|--notify) notify="true" ;;
        -v|--video) config=$video_config ;;
        -q|--hq) config=$hq_config ;;
        -a|--audio) config=$audio_config ;;
        -p|--playlist) config=$playlist_config ;;
        -s|--slow) config=$slow_config ;;
        -u) shift; url="$1" ;;
        --url=*) url=${1#*=} ;;
        http*) url="$1" ;;
        *) arg="$arg $1" ;;
    esac
    shift
done
_download "$arg"
