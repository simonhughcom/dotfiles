#!/bin/sh

# LIMEBAR
# Simon Hugh Moore
#
# Set config options for lemonbar

# Kill any running lemonbar
# pgrep -x lemonbar > /dev/null && pkill -x lemonbar &

font="SourceCodeProSemiBold-13"
icon_font="FontAwesome-13"
geometry="x28"
offset="-2"
clickable_areas=12  # Number of clickable areas.
f_color="#c25704"
b_color="#000000"

prefix=${XDG_RUNTIME_DIR}/melonbar
pipe=$prefix/melonbar_pipe

_cleanup() {
    rm -f $pipe
    exit
}

_update_pipe() {
    if [ -p $pipe ]; then
        echo "$1" > $pipe
    else
        echo "FIFO pipe missing, first execute '$( basename $0 ) run'."
    fi
}


_update(){
    case "$1" in
        window-manager) statusline update window_manager;;
        volume) statusline update volume ;;
        loop) statusline update system ;;
        all) statusline update all;;
        *) statusline update all ;;
    esac

    _update_pipe "$( statusline )"
}


_run(){
    # Create pipe if it doesn't exist and
    #  remove it when exit.
    # If pipe does exist, exit.
    mkdir -p $prefix
    if { mkfifo $pipe 2>/dev/null; }; then
        trap _cleanup INT TERM EXIT
    else
        echo "$(basename $0) is already running, exiting..."
        exit 1
    fi

    # pass contents of pipe into lemonbar
    tail -f "$pipe" | lemonbar -p -a "${clickable_areas}" -f "${font}" -f "${icon_font}" -f "Font Awesome" -o "${offset}" -g "${geometry}" -B "${b_color}" -F "${f_color}" | dash &

    # update statusline once for initialization
    _update all
    # update pipe in an infinite loop that iterates every
    # 30 seconds
    while :; do
        _update loop
        sleep 30
    done
}


case $1 in
    run) _run ;;
    update) shift; _update $@;;
    *) _update ;;
esac
