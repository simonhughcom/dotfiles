#!/bin/sh

# MPV
# Simon Hugh Moore
#
# Wrapper script for mpv to have a persistent profile state.
# Use mpv -P to choose profile.

# mpv runtime dir.
runtime_dir=$XDG_RUNTIME_DIR/mpv
# file to store profile to run.
profile=$runtime_dir/profile

# create runtime dir
mkdir -p "$runtime_dir"
# create profile file
touch -a "$profile"

# mpv wrapper
# Run mpv in a tmux session so that its independant from parent shell.
_mpv(){ tmux new -s mpv -d; tmux send-keys -t mpv "/usr/bin/mpv \"$( echo $@ | sed 's/ /" "/g' )\" &> /dev/null &" ENTER; }

# get profile choice and write in file.
_choose_profile() {
    /usr/bin/mpv --profile=help | awk 'NR>1 {print $1}' | fzf > "$profile"
}

# read profile file and run apropriate profile with mpv
_mpvp(){
    pf=$(head -n 1 $profile)
    echo "Running with profile: $pf"
    [ -z "$pf" ] && _mpv $@ || _mpv "$@" "--profile=$pf"
}

# run mpv -P to choose profile with fzf
case $1 in
    -P) _choose_profile ;;
    *) _mpvp "$@" ;;
esac
