#!/bin/sh

# TERMINAL
# Simon Hugh Moore
#
# Wrapper script for launching terminal

__usage="
Usage: $(basename "$0") [terminal] [OPTIONS]
Common command line arguments for terminal emulators

Options:
  [terminal]                terminal emulator to launch.
  -c                        set class/instace name
  -t                        set title
  -e                        command to run in terminal
  -h, help                  Print this help message.
  *                         Any other command will be passed on to the terminal emulator
"

# check for dependency
_dep() {
    command -v "$1" > /dev/null || { echo "$1 not found"; exit 1; }
}

runtime_dir="$XDG_RUNTIME_DIR/terminal"
pipe="$runtime_dir/pipe"

_make_pipe() {
    [ -p "$pipe" ] && return 0
    mkdir -p "$runtime_dir"
    mkfifo "$pipe" 2> /dev/null
}
_make_pipe

# Returns the state of volume.
_subscribe() {
    _make_pipe
    tail -f "$pipe"
}

_report(){
    echo "$1" > "$pipe"
}

# Replace one cli command with another
_replace(){
    sed "s/^$1[[:blank:]][[:blank:]]*/$2 /;s/[[:blank:]][[:blank:]]*$1[[:blank:]][[:blank:]]*/ $2 /g;s/[[:blank:]][[:blank:]]*$1$/ $2/"
}

_alacritty(){
    _dep "alacritty"

    embed_wid="$( echo "$@" | awk '{for(i=0;i<=NF;i++) if($i == "--embed" ) print $(i+1)}' )"
    
    cmd="$( echo "$@" | _replace "-c" "--class" | _replace "$embed_wid" "$( printf "%d" "$embed_wid" )" )"

    if [ "$HOST" = "mumtop" ]; then
        LIBGL_ALWAYS_SOFTWARE=1 alacritty $cmd
    else
        alacritty $cmd &
    fi
    _report "PID:$!"
}

_urxvt(){
    _dep "urxvt"
    
    cmd="$( echo "$@" | _replace "-t" "-title" | _replace "-c" "-name" )"
    eval "urxvt $cmd"
}

_xst(){
    _dep "xst"
    cmd="$( echo "$@" | _replace "-c" "-n" )"
    eval "xst $cmd"
}

_st(){
    _dep "st"
    cmd="$( echo "$@" | _replace "-c" "-n" )"
    eval "st $cmd"
}

_xterm(){
    _dep "xterm"
    cmd="$( echo "$@" | _replace "-c" "-name" | _replace "-t" "-title" )"
    eval "xterm $cmd"
}

while test $# -gt 0; do
    case "$1" in
        -h|--help) echo "$__usage"; exit ;;
        subscribe) _subscribe ;;
        urxvt) shift; _urxvt "$@"; exit ;;
        st) shift; _st "$@"; exit ;;
        xst) shift; _xst "$@"; exit ;;
        xterm) shift; _xterm "$@"; exit ;;
        alacritty) _alacritty "$@"; exit ;;
        *) _alacritty "$@"; exit ;;
    esac
    shift
done

_alacritty "$@"
